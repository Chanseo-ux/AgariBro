<!doctype html>
<html lang='en'>
  <head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <title>Bro SmartFarm</title>
    <script src='https://cdn.tailwindcss.com'></script>
  </head>
  <body class='bg-white'>
    <div id='root'></div>
    <script type='module' src='/src/main.jsx'></script>
    <div class="ai-drawer" id="aiDrawer">
  <div class="ai-drawer-header">Bro Smartfarm Assistant</div>
  <div class="ai-drawer-body" id="aiBody">
    <div class="msg bot"><div class="bubble">안녕하세요! 스마트팜 질문을 해보세요.</div></div>
  </div>
  <div class="ai-drawer-input">
    <input id="aiInput" placeholder="메시지를 입력하세요..." />
    <button id="aiSend">Send</button>
  </div>
</div>
<button class="ai-tab" id="aiTab" aria-expanded="false">Ask<br>Bro AI</button>

<style>
.ai-tab{position:fixed;right:0;top:40%;transform:translateY(-50%);background:#22c55e;color:#fff;border:none;cursor:pointer;padding:12px 10px;border-top-left-radius:10px;border-bottom-left-radius:10px;font-weight:700;line-height:1.1;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:1000;}
.ai-drawer{position:fixed;right:-360px;bottom:20px;width:340px;max-height:70vh;background:#fff;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.18);display:flex;flex-direction:column;overflow:hidden;transition:right .25s ease;z-index:999;}
.ai-drawer.open{right:20px;}
.ai-drawer-header{background:#16a34a;color:#fff;padding:10px 14px;font-weight:800;}
.ai-drawer-body{padding:12px;overflow-y:auto;flex:1;font-family:system-ui,sans-serif;font-size:14px;}
.msg{margin:8px 0;line-height:1.3;}
.msg .bubble{display:inline-block;padding:10px 12px;border-radius:12px;max-width:85%;}
.msg.user{text-align:right;}
.msg.user .bubble{background:#dcfce7;}
.msg.bot .bubble{background:#f1f5f9;}
.ai-drawer-input{display:flex;gap:8px;padding:10px;border-top:1px solid #e5e7eb;}
.ai-drawer-input input{flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;}
.ai-drawer-input button{padding:10px 14px;border:none;border-radius:10px;background:#22c55e;color:#fff;cursor:pointer;}
@media(max-width:520px){.ai-drawer{width:95vw;right:-100vw;}.ai-drawer.open{right:2.5vw;}}
</style>

<script>
const apiBase = "/api/chat";
const drawer = document.getElementById("aiDrawer");
const tabBtn = document.getElementById("aiTab");
const bodyEl = document.getElementById("aiBody");
const inputEl = document.getElementById("aiInput");
const sendBtn = document.getElementById("aiSend");
let history = [];

function append(role,text){
  const div=document.createElement("div");
  div.className=`msg ${role}`;
  const b=document.createElement("div");
  b.className="bubble";
  b.textContent=text;
  div.appendChild(b);
  bodyEl.appendChild(div);
  bodyEl.scrollTop=bodyEl.scrollHeight;
}

tabBtn.addEventListener("click",()=>{
  const open=drawer.classList.toggle("open");
  tabBtn.setAttribute("aria-expanded",open?"true":"false");
  if(open) inputEl.focus();
});

async function send(){
  const text=inputEl.value.trim();
  if(!text) return;
  inputEl.value="";
  append("user",text);
  history.push({role:"user",content:text});
  try{
    const r=await fetch(apiBase,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:history})});
    const data=await r.json();
    const reply=data.reply || "응답이 없어요.";
    append("bot",reply);
    history.push({role:"assistant",content:reply});
  }catch(e){
    append("bot","서버 오류가 발생했어요.");
    console.error(e);
  }
}

sendBtn.addEventListener("click",send);
inputEl.addEventListener("keydown",e=>{if(e.key==="Enter") send();});
</script>
    <!-- Mini YouTube inside the drawer -->
<div id="mini-yt" style="padding:10px;">
  <div style="display:flex;gap:8px;align-items:center;">
    <input id="ytQuery" placeholder="Search YouTube…" style="flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;">
    <button id="ytBtn" style="padding:10px 14px;border:none;border-radius:10px;background:#22c55e;color:#fff;cursor:pointer;">Search</button>
  </div>
  <div id="ytResults" style="margin-top:12px;"></div>
</div>

<script>
async function ytSearch() {
  const q = document.getElementById("ytQuery").value.trim();
  if (!q) return;
  const box = document.getElementById("ytResults");
  box.innerHTML = "Searching…";
  try {
    const r = await fetch(`/api/youtube?q=${encodeURIComponent(q)}`);
    const data = await r.json();
    if (!data.items?.length) { box.innerHTML = "No results."; return; }
    box.innerHTML = data.items.map(v => `
      <div style="margin-bottom:14px;">
        <iframe
          width="100%" height="200"
          src="https://www.youtube-nocookie.com/embed/${v.videoId}"
          title="${v.title.replace(/"/g,'&quot;')}"
          frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen loading="lazy"></iframe>
        <div style="font:14px/1.3 system-ui;margin-top:6px;">${v.title}</div>
        <div style="font:12px/1.2 system-ui;color:#64748b;">${v.channel}</div>
      </div>
    `).join("");
  } catch (e) {
    console.error(e);
    box.innerHTML = "Error loading results.";
  }
}
document.getElementById("ytBtn").addEventListener("click", ytSearch);
document.getElementById("ytQuery").addEventListener("keydown", e => { if (e.key === "Enter") ytSearch(); });
</script>
  </body>
</html>
